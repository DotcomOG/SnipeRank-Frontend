<!-- full-report.html — Updated to read from sessionStorage -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Full AI SEO Report – SnipeRank</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-white text-black font-sans">

  <header class="text-center py-8">
    <h1 class="text-4xl font-bold">SnipeRank</h1>
    <h2 class="text-xl font-medium mt-1">Full AI SEO Analysis Report</h2>
  </header>

  <main class="max-w-4xl mx-auto px-6 py-8 space-y-6">
    <div id="fullResultUrl" class="text-xl font-semibold text-center"></div>
    <div id="fullScore" class="text-center text-2xl font-bold my-4"></div>

    <section>
      <h2 class="text-xl font-bold mt-8 mb-2">What's Working</h2>
      <ul id="fullStrengths" class="list-disc list-inside space-y-3"></ul>
    </section>

    <section>
      <h2 class="text-xl font-bold mt-8 mb-2">Needs Attention</h2>
      <ul id="fullOpportunities" class="list-disc list-inside space-y-3"></ul>
    </section>

    <section>
      <h2 class="text-xl font-bold mt-8 mb-2">AI Engine Insights</h2>
      <ul id="fullEngineInsights" class="list-disc list-inside space-y-3"></ul>
    </section>

    <section class="mt-12 border-t border-gray-300 pt-8">
      <h3 class="text-2xl font-semibold mb-4 text-center">Request a Free Consultation</h3>
      <form method="POST" action="https://formspree.io/f/mayzkzed" class="space-y-4 max-w-xl mx-auto">
        <input type="text" id="name" name="name" placeholder="Your Full Name" class="w-full p-2 rounded border text-black" required />
        <input type="email" id="email" name="email" placeholder="Your Email Address" class="w-full p-2 rounded border text-black" required />
        <input type="tel" name="phone" placeholder="Phone (required)" class="w-full p-2 rounded border text-black" required />
        <input type="text" name="company" placeholder="Company / Organization (Optional)" class="w-full p-2 rounded border text-black" />
        <textarea name="notes" placeholder="Your message (Optional)" class="w-full p-2 rounded border text-black h-32"></textarea>
        <button type="submit" class="bg-black text-white px-4 py-2 rounded hover:bg-gray-800 w-full">Submit</button>
      </form>
    </section>
  </main>

  <script>
    async function runFullReport() {
      // Try URL parameters first (for direct links)
      const params = new URLSearchParams(window.location.search);
      let url = params.get("url");
      let name = params.get("name") || "";
      let email = params.get("email") || "";

      // If not in URL, try sessionStorage (from analyze.html form)
      if (!url) {
        url = sessionStorage.getItem('sniperank:url');
      }
      if (!name) {
        name = sessionStorage.getItem('sniperank:name') || "";
      }
      if (!email) {
        email = sessionStorage.getItem('sniperank:email') || "";
      }

      // Validate we have required data
      if (!url) {
        document.body.innerHTML = '<div class="text-center mt-8"><p class="text-red-500">No URL provided for analysis.</p><a href="/analyze.html" class="text-blue-500 underline">Return to Analysis</a></div>';
        return;
      }

      // Populate form fields
      document.getElementById("name").value = decodeURIComponent(name);
      document.getElementById("email").value = decodeURIComponent(email);
      document.getElementById("fullResultUrl").textContent = decodeURIComponent(url);

      // Also populate phone and company if available from sessionStorage
      const phone = sessionStorage.getItem('sniperank:phone');
      const company = sessionStorage.getItem('sniperank:company');
      if (phone) {
        document.querySelector('input[name="phone"]').value = phone;
      }
      if (company) {
        document.querySelector('input[name="company"]').value = company;
      }

      try {
        const res = await fetch(`/api/full?url=${encodeURIComponent(url)}`);
        const data = await res.json();

        if (!data.success) {
          document.body.innerHTML += "<p class='text-red-500 text-center mt-8'>Analysis failed. Try again.</p>";
          return;
        }

        document.getElementById("fullScore").textContent = `Score: ${data.score}`;

        // Handle different possible response formats
        const strengths = data.ai_strengths || data.whatsWorking || [];
        const opportunities = data.ai_opportunities || data.needsAttention || [];
        const insights = data.engine_insights || data.engineInsights || [];

        strengths.forEach(item => {
          const li = document.createElement("li");
          li.textContent = item;
          document.getElementById("fullStrengths").appendChild(li);
        });

        opportunities.forEach(item => {
          const li = document.createElement("li");
          li.textContent = item;
          document.getElementById("fullOpportunities").appendChild(li);
        });

        insights.forEach(item => {
          const li = document.createElement("li");
          li.textContent = item;
          document.getElementById("fullEngineInsights").appendChild(li);
        });
      } catch (err) {
        console.error(err);
        document.body.innerHTML += "<p class='text-red-500 text-center mt-8'>Error loading report.</p>";
      }
    }

    runFullReport();
  </script>
</body>
</html>
