<!DOCTYPE html>
<html lang="en">
<head>
  <!-- analyze.html — v2025.10.22-approve — Approved analyzer with progress -->
  <!-- Flow: index -> analyze (this file) -> full-report -->
  <!-- Fetches from /api/friendly?url=... and renders Score, Superpowers, Opportunities, Insights -->
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SnipeRank — AI Visibility Report</title>
  <meta name="description" content="AI Visibility Score and actionable AI-SEO insights for your site." />
  <style>
    :root{
      --max:980px; --pad:20px; --muted:#6b7280; --text:#111827; --bg:#ffffff;
      --card:#ffffff; --shadow:0 10px 30px rgba(0,0,0,.08); --border:#e5e7eb; --accent:#2563eb;
      --chip:#f3f4f6; --ok:#16a34a; --warn:#f59e0b; --bad:#ef4444; --light:#f9fafb;
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{margin:0; font:16px/1.5 ui-sans-serif,system-ui,Segoe UI,Roboto,Inter,Arial,sans-serif; color:var(--text); background:var(--light);}
    header{
      position:sticky; top:0; background:rgba(255,255,255,.9); backdrop-filter:saturate(180%) blur(8px);
      border-bottom:1px solid var(--border); z-index:10;
    }
    .bar{max-width:var(--max); margin:0 auto; padding:10px var(--pad); display:flex; align-items:center; gap:14px;}
    .brand{font-weight:800; letter-spacing:.2px}
    .dot{width:8px; height:8px; border-radius:50%; background:var(--accent); display:inline-block; margin-right:6px}
    .url{color:var(--muted); font-size:.93rem; overflow:hidden; text-overflow:ellipsis; white-space:nowrap}
    .actions{margin-left:auto; display:flex; gap:8px}
    .btn{
      appearance:none; border:1px solid var(--border); background:#fff; padding:8px 12px; border-radius:10px; cursor:pointer;
      font-weight:600;
    }
    .btn.primary{background:var(--accent); color:#fff; border-color:var(--accent)}
    .wrap{max-width:var(--max); margin:22px auto; padding:0 var(--pad) 60px}
    .scoreCard{
      display:flex; gap:16px; align-items:center; background:var(--card); border:1px solid var(--border);
      border-radius:var(--radius); box-shadow:var(--shadow); padding:16px 18px; margin-bottom:16px;
    }
    .badge{
      width:48px; height:48px; border-radius:50%; display:grid; place-items:center; color:#fff; font-weight:800;
      background:linear-gradient(135deg,#f59e0b,#f97316);
    }
    .meta{display:flex; flex-direction:column; gap:2px}
    .meta .title{font-weight:800}
    .meta .sub{color:var(--muted); font-size:.9rem}
    .progress{
      width:100%; height:10px; background:#eef2ff; border-radius:999px; overflow:hidden; margin-left:auto; max-width:320px
    }
    .progress > div{height:100%; width:0%; background:var(--accent); transition:width .3s ease}
    .grid{display:grid; grid-template-columns:1fr; gap:16px; margin-top:16px}
    @media(min-width:860px){ .grid{grid-template-columns:1fr 1fr} }
    .card{
      background:var(--card); border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow); padding:16px 18px;
    }
    h3{margin:0 0 8px}
    ul{margin:0; padding-left:20px}
    .insights{margin-top:16px}
    .muted{color:var(--muted)}
    .pill{display:inline-block; background:var(--chip); border:1px solid var(--border); padding:2px 8px; border-radius:999px; font-size:.85rem; color:#374151}
    .err{color:var(--bad); background:#fff1f2; border:1px solid #fecaca; padding:12px 14px; border-radius:12px; display:none; margin-top:12px}
    .hide{display:none}
    footer{max-width:var(--max); margin:28px auto 60px; padding:0 var(--pad); color:var(--muted); font-size:.92rem}
    a{color:var(--accent); text-decoration:none} a:hover{text-decoration:underline}
  </style>
</head>
<body>
  <header>
    <div class="bar">
      <span class="brand"><span class="dot"></span>SnipeRank</span>
      <span id="site-url" class="url"></span>
      <div class="actions">
        <button class="btn" id="btn-another">Analyze another site</button>
        <a class="btn" href="/index.html">Home</a>
        <a class="btn primary" id="btn-full" href="#">Full report</a>
      </div>
    </div>
  </header>

  <div class="wrap">
    <div class="scoreCard">
      <div class="badge" id="score-badge">—</div>
      <div class="meta">
        <div class="title">AI Visibility Score: <span id="score-label">—</span></div>
        <div class="sub" id="generated-at">Waiting for analysis…</div>
      </div>
      <div class="progress" title="Live analysis progress">
        <div id="progress-fill"></div>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <h3>Superpowers (What’s working)</h3>
        <ul id="superpowers">
          <li class="muted">We’ll list the strengths found on your site…</li>
        </ul>
      </div>
      <div class="card">
        <h3>Opportunities (What’s holding you back)</h3>
        <ul id="opportunities">
          <li class="muted">And here are targeted fixes with impact…</li>
        </ul>
      </div>
    </div>

    <div class="card insights">
      <h3>Insights</h3>
      <ul id="insights">
        <li class="muted">Model perspectives from multiple AI systems…</li>
      </ul>
      <div class="err" id="err">Failed to load report. Please try again.</div>
    </div>

    <footer>
      Prefer help implementing fixes? <a href="mailto:hello@quontora.com?subject=SnipeRank%20Consultation">Contact us for a free consultation</a>.
    </footer>
  </div>

  <script>
    // ---------- Helpers ----------
    const qs = new URLSearchParams(location.search);
    const targetUrl = qs.get('url') || '';
    const nameParam = qs.get('n') || '';
    const emailParam = qs.get('e') || '';
    const $ = (s) => document.querySelector(s);
    const byId = (id) => document.getElementById(id);

    // ---------- UI wiring ----------
    byId('site-url').textContent = targetUrl || '';
    byId('btn-another').addEventListener('click', () => { window.location.href = '/index.html'; });
    byId('btn-full').addEventListener('click', (e) => {
      e.preventDefault();
      const dest = `/full-report.html?url=${encodeURIComponent(targetUrl)}&n=${encodeURIComponent(nameParam)}&e=${encodeURIComponent(emailParam)}`;
      window.location.href = dest;
    });

    // Progress simulation while we fetch (0 → 90%), final jump to 100% on render
    let p = 0;
    const fill = byId('progress-fill');
    const tick = setInterval(() => {
      p = Math.min(90, p + Math.random()*9 + 3);
      fill.style.width = p.toFixed(0) + '%';
    }, 300);

    // ---------- Fetch report ----------
    async function run() {
      if (!targetUrl) {
        byId('err').style.display = 'block';
        byId('err').textContent = 'Missing ?url= parameter.';
        clearInterval(tick);
        return;
      }
      try {
        const endpoint = `/api/friendly?url=${encodeURIComponent(targetUrl)}`;
        const res = await fetch(endpoint, { headers: { 'Accept': 'application/json' }});
        if (!res.ok) throw new Error(`API ${res.status}`);
        const data = await res.json();

        // Expected shape: { score:number (0-10), strengths:string[], opportunities:string[], insights:string[], generatedAt?: string }
        const score = Number(data.score ?? 0);
        const strengths = Array.isArray(data.strengths) ? data.strengths : (data.superpowers || []);
        const opps = Array.isArray(data.opportunities) ? data.opportunities : (data.issues || []);
        const insights = Array.isArray(data.insights) ? data.insights : [];

        // Render
        byId('score-badge').textContent = isNaN(score) ? '—' : String(score);
        byId('score-label').textContent = isNaN(score) ? '—' : `${score} / 10`;
        byId('generated-at').textContent = (data.generatedAt ? `Generated ${data.generatedAt}` : `Generated ${new Date().toLocaleString()}`) + ' • SnipeRank v2.0';

        renderList('#superpowers', strengths);
        renderList('#opportunities', opps);
        renderList('#insights', insights);

        clearInterval(tick);
        requestAnimationFrame(() => { fill.style.width = '100%'; });

      } catch (e) {
        console.error(e);
        byId('err').style.display = 'block';
        clearInterval(tick);
      }
    }

    function renderList(sel, items){
      const el = $(sel);
      el.innerHTML = '';
      if (!items || !items.length){
        const li = document.createElement('li');
        li.textContent = 'No data.';
        el.appendChild(li);
        return;
      }
      items.forEach(text => {
        const li = document.createElement('li');
        li.textContent = text;
        el.appendChild(li);
      });
    }

    run();
  </script>
</body>
</html>
